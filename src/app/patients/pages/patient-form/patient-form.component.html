<mat-card class="wfull">
  <h2>{{ id ? 'Edit admission' : 'New admission' }}</h2>

  <form [formGroup]="form" (ngSubmit)="submit()" class="wfull">
    <mat-stepper linear class="wfull">

      <!-- Step 1: Demographics -->
      <mat-step [stepControl]="demographicsFG">
        <form [formGroup]="demographicsFG" class="grid">
          <ng-template matStepLabel>1) Demographics</ng-template>

          <mat-form-field class="full">
            <mat-label>Legal name</mat-label>
            <input matInput formControlName="legalName" required />
            <mat-error *ngIf="demographicsFG.controls['legalName']?.invalid">Required</mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Preferred name</mat-label>
            <input matInput formControlName="preferredName" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Gender</mat-label>
            <input matInput formControlName="gender" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Date of birth</mat-label>
            <input matInput [matDatepicker]="dob" formControlName="dob" required />
            <mat-datepicker-toggle matSuffix [for]="dob"></mat-datepicker-toggle>
            <mat-datepicker #dob></mat-datepicker>
            <mat-error *ngIf="demographicsFG.controls['dob']?.invalid">Required</mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Date of Admission</mat-label>
            <input matInput [matDatepicker]="admissionDate" formControlName="admissionDate" required />
            <mat-datepicker-toggle matSuffix [for]="admissionDate"></mat-datepicker-toggle>
            <mat-datepicker #admissionDate></mat-datepicker>
            <mat-error *ngIf="demographicsFG.controls['admissionDate']?.invalid">Required</mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Phone</mat-label>
            <input matInput formControlName="phone" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" />
          </mat-form-field>

          <mat-form-field class="full">
            <mat-label>Address line 1</mat-label>
            <input matInput formControlName="address1" />
          </mat-form-field>

          <mat-form-field class="full">
            <mat-label>Address line 2</mat-label>
            <input matInput formControlName="address2" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>City</mat-label>
            <input matInput formControlName="city" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>State/Province</mat-label>
            <input matInput formControlName="state" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>ZIP/Postal code</mat-label>
            <input matInput formControlName="zip" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Country</mat-label>
            <input matInput formControlName="country" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Language</mat-label>
            <input matInput formControlName="language" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Marital status</mat-label>
            <input matInput formControlName="maritalStatus" />
          </mat-form-field>

          <div class="row-actions full">
            <button mat-raised-button color="primary" matStepperNext [disabled]="demographicsFG.invalid">Continue</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Identity / Payor -->
      <mat-step [stepControl]="identityFG">
        <form [formGroup]="identityFG" class="grid">
          <ng-template matStepLabel>2) Identity & Payor</ng-template>

          <mat-form-field>
            <mat-label>SSN / National ID</mat-label>
            <input matInput formControlName="ssn" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>ID Type</mat-label>
            <input matInput formControlName="idType" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>ID Number</mat-label>
            <input matInput formControlName="idNumber" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Insurance provider</mat-label>
            <input matInput formControlName="insuranceProvider" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Insurance ID</mat-label>
            <input matInput formControlName="insuranceId" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Group number</mat-label>
            <input matInput formControlName="groupNumber" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Payor</mat-label>
            <input matInput formControlName="payor" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Policy holder</mat-label>
            <input matInput formControlName="policyHolder" />
          </mat-form-field>

          <mat-form-field class="full">
            <mat-label>Emergency contact (name)</mat-label>
            <input matInput formControlName="emergencyContactName" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Emergency phone</mat-label>
            <input matInput formControlName="emergencyContactPhone" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Relationship</mat-label>
            <input matInput formControlName="emergencyRelation" />
          </mat-form-field>

          <div class="row-actions full">
            <button mat-stroked-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" matStepperNext>Continue</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Clinical -->
      <mat-step [stepControl]="clinicalFG">
        <form [formGroup]="clinicalFG" class="grid">
          <ng-template matStepLabel>3) Clinical</ng-template>

          <mat-form-field class="full">
            <mat-label>Reason for admission</mat-label>
            <textarea matInput formControlName="reasonForAdmission" rows="2"></textarea>
          </mat-form-field>

          <mat-form-field class="full">
            <mat-label>Primary Care Provider (PCP)</mat-label>
            <input matInput formControlName="primaryCareProvider" />
          </mat-form-field>

          <mat-form-field class="full">
            <mat-label>Referring provider</mat-label>
            <input matInput formControlName="referringProvider" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Code status</mat-label>
            <input matInput formControlName="codeStatus" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Preferred pharmacy</mat-label>
            <input matInput formControlName="preferredPharmacy" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Height (cm)</mat-label>
            <input matInput type="number" formControlName="heightCm" />
          </mat-form-field>

          <mat-form-field>
            <mat-label>Weight (kg)</mat-label>
            <input matInput type="number" formControlName="weightKg" />
          </mat-form-field>

          <!-- Diagnoses -->
          <div class="full">
            <h4>Diagnoses</h4>
            <div class="list-input">
              <input #dxInput matInput placeholder="Add a diagnosis"
                     (keyup.enter)="addDiagnosis(dxInput.value); dxInput.value='';" />
              <button mat-stroked-button type="button"
                      (click)="addDiagnosis(dxInput.value); dxInput.value=''">Add</button>
            </div>
            <ul class="chips">
              <li *ngFor="let d of dxFA.controls; let i = index">
                <span>{{ d.value }}</span>
                <button type="button" mat-icon-button (click)="removeDiagnosis(i)">
                  <mat-icon>close</mat-icon>
                </button>
              </li>
            </ul>
          </div>

          <!-- Allergies -->
          <div class="full">
            <h4>Allergies</h4>
            <div class="list-input">
              <input #alInput matInput placeholder="Add an allergy"
                     (keyup.enter)="addAllergy(alInput.value); alInput.value='';" />
              <button mat-stroked-button type="button"
                      (click)="addAllergy(alInput.value); alInput.value=''">Add</button>
            </div>
            <ul class="chips">
              <li *ngFor="let a of algFA.controls; let i = index">
                <span>{{ a.value }}</span>
                <button type="button" mat-icon-button (click)="removeAllergy(i)">
                  <mat-icon>close</mat-icon>
                </button>
              </li>
            </ul>
          </div>

          <div class="row-actions full">
            <button mat-stroked-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" matStepperNext>Continue</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 4: Consents -->
      <mat-step [stepControl]="consentFG">
        <form [formGroup]="consentFG" class="grid">
          <ng-template matStepLabel>4) Consents</ng-template>

          <mat-checkbox formControlName="hipaaAck">
            I have provided and explained the HIPAA Notice to the patient.
          </mat-checkbox>
          <mat-checkbox formControlName="privacyNoticeAck">
            The patient received the Privacy Notice.
          </mat-checkbox>
          <mat-checkbox formControlName="financialAgreementAck">
            The patient accepts the financial terms.
          </mat-checkbox>

          <div class="row-actions full">
            <button mat-stroked-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="consentFG.invalid">Review</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 5: Review & Submit -->
      <mat-step>
        <ng-template matStepLabel>5) Review & Submit</ng-template>

        <div class="summary full">
          <h3>Summary</h3>
          <div>
            <strong>Patient:</strong>
            {{ demVal['legalName'] || '—' }} •
            DOB: {{ demVal['dob'] | date:'yyyy-MM-dd' }} •
            {{ demVal['gender'] || '—' }}
          </div>
          <div><strong>Payor:</strong> {{ idVal['payor'] || '—' }}</div>
          <div><strong>Reason:</strong> {{ clinVal['reasonForAdmission'] || '—' }}</div>
          <div><strong>PCP:</strong> {{ clinVal['primaryCareProvider'] || '—' }}</div>
        </div>

        <div class="row-actions full">
          <button mat-stroked-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="submitting || form.invalid">
            <mat-icon>save</mat-icon>&nbsp;Save
          </button>
          <a mat-button routerLink="/patients">Cancel</a>
        </div>
      </mat-step>

    </mat-stepper>
  </form>
</mat-card>
