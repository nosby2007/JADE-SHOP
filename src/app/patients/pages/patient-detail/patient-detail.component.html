<mat-card *ngIf="(patient$ | async) as p; else loading" class="wfull">
  <div class="flex-between header">
    <div>
      <h2 class="title">{{ ($any(p).demographics?.legalName || p.name) || 'Patient' }}</h2>
      <div class="subtitle">
        DOB:
        {{
          (
            $any(p).demographics?.dob?.toDate?.() ||
            $any(p).demographics?.dob ||
            $any(p).dob?.toDate?.() ||
            p.dob
          ) | date:'yyyy-MM-dd'
        }}
        • {{ $any(p).demographics?.gender || p.gender || '—' }}
      </div>
    </div>

    <div class="actions">
      <a mat-stroked-button color="primary" [routerLink]="['/patients', p.id, 'edit']">
        <mat-icon>edit</mat-icon>&nbsp;Edit
      </a>
      <a mat-button [routerLink]="['/patients']">Retour patient</a>
    </div>
  </div>

  <!-- Sections grid -->
  <div class="sections">
    <!-- Demographics -->
    <mat-card class="section">
      <h3>Demographics</h3>
      <div class="grid two">
        <div><b>Legal name:</b> {{ $any(p).demographics?.legalName || p.name || '—' }}</div>
        <div><b>Preferred name:</b> {{ $any(p).demographics?.preferredName || '—' }}</div>

        <div>
          <b>DOB:</b>
          {{
            (
              $any(p).demographics?.dob?.toDate?.() ||
              $any(p).demographics?.dob ||
              $any(p).dob?.toDate?.() ||
              p.dob
            ) | date:'yyyy-MM-dd'
          }}
        </div>
        <div><b>Gender:</b> {{ $any(p).demographics?.gender || p.gender || '—' }}</div>

        <div><b>Phone:</b> {{ $any(p).demographics?.phone || p.phone || '—' }}</div>
        <div><b>Email:</b> {{ $any(p).demographics?.email || p.email || '—' }}</div>

        <div class="full">
          <b>Address:</b> {{ address(p) }}
        </div>

        <div><b>City:</b> {{ $any(p).demographics?.city || $any(p).city || '—' }}</div>
        <div><b>State/Province:</b> {{ $any(p).demographics?.state || $any(p).state || '—' }}</div>
        <div><b>ZIP:</b> {{ $any(p).demographics?.zip || $any(p).zip || '—' }}</div>
        <div><b>Country:</b> {{ $any(p).demographics?.country || $any(p).country || '—' }}</div>

        <div><b>Language:</b> {{ $any(p).demographics?.language || $any(p).language || '—' }}</div>
        <div><b>Marital status:</b> {{ $any(p).demographics?.maritalStatus || $any(p).maritalStatus || '—' }}</div>
      </div>
    </mat-card>

    <!-- Identity & Payor -->
    <mat-card class="section">
      <h3>Identity & Payor</h3>
      <div class="grid two">
        <div><b>SSN / National ID:</b> {{ $any(p).identity?.ssn || '—' }}</div>
        <div><b>ID Type:</b> {{ $any(p).identity?.idType || '—' }}</div>
        <div><b>ID Number:</b> {{ $any(p).identity?.idNumber || '—' }}</div>

        <div><b>Insurance provider:</b> {{ $any(p).identity?.insuranceProvider || '—' }}</div>
        <div><b>Insurance ID:</b> {{ $any(p).identity?.insuranceId || '—' }}</div>
        <div><b>Group #:</b> {{ $any(p).identity?.groupNumber || '—' }}</div>

        <div><b>Payor:</b> {{ $any(p).identity?.payor || $any(p).paiement || $any(p).payor || '—' }}</div>
        <div><b>Policy holder:</b> {{ $any(p).identity?.policyHolder || '—' }}</div>

        <div class="full"><b>Emergency contact:</b> {{ $any(p).identity?.emergencyContactName || '—' }}</div>
        <div><b>Emergency phone:</b> {{ $any(p).identity?.emergencyContactPhone || '—' }}</div>
        <div><b>Relationship:</b> {{ $any(p).identity?.emergencyRelation || '—' }}</div>
      </div>
    </mat-card>

    <!-- Clinical -->
    <mat-card class="section">
      <h3>Clinical</h3>
      <div class="grid two">
        <div class="full">
          <b>Reason for admission:</b> {{ $any(p).clinical?.reasonForAdmission || $any(p).raison || '—' }}
        </div>

        <div class="full">
          <b>Primary Care Provider (PCP):</b> {{ $any(p).clinical?.primaryCareProvider || $any(p).docteur || '—' }}
        </div>

        <div class="full"><b>Referring provider:</b> {{ $any(p).clinical?.referringProvider || '—' }}</div>

        <div><b>Code status:</b> {{ $any(p).clinical?.codeStatus || '—' }}</div>
        <div><b>Preferred pharmacy:</b> {{ $any(p).clinical?.preferredPharmacy || '—' }}</div>

        <div><b>Height (cm):</b> {{ $any(p).clinical?.heightCm || '—' }}</div>
        <div><b>Weight (kg):</b> {{ $any(p).clinical?.weightKg || '—' }}</div>
      </div>

      <div class="lists">
        <div>
          <h4>Diagnoses</h4>
          <ul class="chips">
            <li *ngFor="let d of ($any(p).clinical?.diagnoses || $any(p).diagnoses || [])">{{ d }}</li>
            <li *ngIf="!($any(p).clinical?.diagnoses?.length || $any(p).diagnoses?.length)" class="muted">None</li>
          </ul>
        </div>
        <div>
          <h4>Allergies</h4>
          <ul class="chips">
            <li *ngFor="let a of ($any(p).clinical?.allergies || $any(p).allergies || [])">{{ a }}</li>
            <li *ngIf="!($any(p).clinical?.allergies?.length || $any(p).allergies?.length)" class="muted">None</li>
          </ul>
        </div>
      </div>
    </mat-card>

    <!-- Consents -->
    <mat-card class="section">
      <h3>Consents</h3>
      <div class="consents">
        <div class="consent">
          <mat-icon [class.ok]="$any(p).consent?.hipaaAck" [class.no]="!$any(p).consent?.hipaaAck">
            {{ $any(p).consent?.hipaaAck ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span>HIPAA Notice acknowledged</span>
        </div>
        <div class="consent">
          <mat-icon [class.ok]="$any(p).consent?.privacyNoticeAck" [class.no]="!$any(p).consent?.privacyNoticeAck">
            {{ $any(p).consent?.privacyNoticeAck ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span>Privacy Notice received</span>
        </div>
        <div class="consent">
          <mat-icon [class.ok]="$any(p).consent?.financialAgreementAck" [class.no]="!$any(p).consent?.financialAgreementAck">
            {{ $any(p).consent?.financialAgreementAck ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span>Financial Agreement accepted</span>
        </div>
      </div>
    </mat-card>

  </div>
</mat-card>


<ng-template #loading>
  <div class="p-6 flex center"><mat-spinner diameter="36"></mat-spinner></div>
</ng-template>