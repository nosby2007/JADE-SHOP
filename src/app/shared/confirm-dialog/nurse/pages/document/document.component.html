<div class="documents-container" *ngIf="!loading; else loadingTpl">
  <div class="header-row">
    <h2>Documents du patient</h2>

    <div class="filters">
      <mat-chip-list class="chip-bar" aria-label="Filtre rapide">
        <mat-chip selectable="false" [selected]="selectedFilter==='All'" (click)="applyQuickFilter('All')">
          All
        </mat-chip>
        <mat-chip selectable="false" [selected]="selectedFilter==='Photos'" (click)="applyQuickFilter('Photos')">
          Photos
        </mat-chip>
        <mat-chip selectable="false" [selected]="selectedFilter==='PDF'" (click)="applyQuickFilter('PDF')">
          PDF
        </mat-chip>
      </mat-chip-list>
    </div>

    <div class="actions-bar">
      <button mat-raised-button color="primary" (click)="openUploadDialog()">
        <mat-icon>upload_file</mat-icon>
        Ad a document
      </button>
    </div>
  </div>

  <!-- ✅ key change is the ( ... ?? 0 ) > 0 -->
  <ng-container *ngIf="(dataSource?.data?.length ?? 0) > 0; else noDocumentsTemplate">
    <div class="mat-elevation-z8">
      <table mat-table [dataSource]="dataSource" class="mat-table" matSort>

        <!-- Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
          <td mat-cell *matCellDef="let doc">{{ doc.name }}</td>
        </ng-container>

        <!-- Type -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
          <td mat-cell *matCellDef="let doc">{{ doc.type || '—' }}</td>
        </ng-container>

        <!-- Description -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let doc">
            <span class="truncate" [matTooltip]="doc.description || ''">
              {{ doc.description || '—' }}
            </span>
          </td>
        </ng-container>

        <!-- Date -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
          <td mat-cell *matCellDef="let doc">
            {{ (doc.createdAt?.toDate ? doc.createdAt.toDate() : doc.createdAt) | date:'short' }}
          </td>
        </ng-container>

        <!-- Actions -->
        <!-- Actions (download + delete) -->
        <ng-container matColumnDef="download">
          <th mat-header-cell *matHeaderCellDef class="actions-col">Actions</th>
          <td mat-cell *matCellDef="let doc" class="actions-col">
            <a *ngIf="doc.url" [href]="doc.url" target="_blank" mat-icon-button aria-label="Télécharger">
              <mat-icon>download</mat-icon>
            </a>
            <button mat-icon-button color="warn" (click)="deleteDocument(doc)" aria-label="Supprimer">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>
    </div>
  </ng-container>
</div>

<!-- Loading -->
<ng-template #loadingTpl>
  <div class="loading">
    <mat-spinner diameter="42"></mat-spinner>
    <p>loading documents…</p>
  </div>
</ng-template>

<!-- Empty state -->
<ng-template #noDocumentsTemplate>
  <div class="empty-state-container animate__animated animate__fadeIn">
    <img
      src="https://res.cloudinary.com/dtdpx59sc/image/upload/v1743378227/ChatGPT_Image_30_mars_2025_19_43_33_y6hyb7.png"
      alt="Aucun document"
      class="empty-image"
    />
    <h3>No document found.</h3>
    <p class="message">clic on add a document » to add.</p>
  </div>
</ng-template>
