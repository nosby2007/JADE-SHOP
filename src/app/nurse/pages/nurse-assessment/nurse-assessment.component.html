<mat-card class="card">
  <div class="flex-between">
    <h2>Assessments</h2>
    <div class="actions">
      <button mat-stroked-button color="primary" (click)="compileAdmission()">PDF Admission</button>
      <button mat-stroked-button color="accent" (click)="compileDischarge()">PDF Discharge</button>
    </div>
  </div>

  <mat-tab-group>
    <mat-tab *ngFor="let t of tabs" [label]="t.label">
      <div class="tab-actions">
        <button mat-raised-button color="primary" (click)="openAdd(t.key)">
          <mat-icon>add</mat-icon>&nbsp;Add
        </button>

        <button *ngIf="$any(t.key) === 'vitalSigns'"
                mat-stroked-button color="primary"
                (click)="openVitalsTrend()">
          <mat-icon>show_chart</mat-icon>&nbsp;Trend
        </button>
      </div>

      <!-- Inline chart for Vital Signs tab -->
      <div *ngIf="$any(t.key) === 'vitalSigns'" class="vitals-inline-chart">
        <div echarts [options]="$any((vitalsOptions$ | async) || {})" class="h-56 w-full"></div>
      </div>

      <table mat-table [dataSource]="(streams[t.key] | async) || []"
             class="mat-elevation-z2 full-table">
        <!-- Date -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let a">{{ displayDate(a) | date:'short' }}</td>
        </ng-container>

        <!-- Summary -->
        <ng-container matColumnDef="summary">
          <th mat-header-cell *matHeaderCellDef>Summary</th>
          <td mat-cell *matCellDef="let a">
            <ng-container [ngSwitch]="a.type">
              <span *ngSwitchCase="'braden'">
                Braden: {{ ($any(a)).score }} ({{ ($any(a)).risk }})
              </span>

              <span *ngSwitchCase="'skinWeekly'">
                {{ ($any(a)).findings | slice:0:80 }}{{ ($any(a)).findings?.length > 80 ? '…' : '' }}
              </span>

              <span *ngSwitchCase="'pressureInjuryWeekly'">
                Stage {{ ($any(a)).stage }} • {{ ($any(a)).location }}
              </span>

              <span *ngSwitchCase="'progressNote'">
                {{ ($any(a)).authorRole }} •
                {{ ($any(a)).note | slice:0:80 }}{{ ($any(a)).note?.length > 80 ? '…' : '' }}
              </span>

              <span *ngSwitchCase="'carePlan'">
                Dx: {{ ($any(a)).diagnoses?.length || 0 }}
                • Goals: {{ ($any(a)).goals?.length || 0 }}
              </span>

              <!-- Vital Signs -->
              <span *ngSwitchCase="'vitalSigns'">
                BP {{ vs(a,'systolic') ?? '—' }}/{{ vs(a,'diastolic') ?? '—' }}
                • HR {{ vs(a,'heartRate') ?? '—' }}
                • RR {{ vs(a,'respiratoryRate') ?? '—' }}
                • Temp {{ (vs(a,'temperatureC') ?? '—') }}°C
                • SpO₂ {{ (vs(a,'spo2') ?? '—') }}%
                <ng-container *ngIf="vs(a,'painScore') != null">
                  • Pain {{ vs(a,'painScore') }}
                </ng-container>
              </span>

              <!-- Antibiotic -->
              <span *ngSwitchCase="'antibiotic'">
                Med: {{
                  ($any(a).medication) ||
                  ($any(a).antibiotic?.core?.medication) || '—'
                }}
                • Prescriber: {{
                  ($any(a).prescriber) ||
                  ($any(a).antibiotic?.core?.prescriber) || '—'
                }}
                <ng-container *ngIf="$any(a).indication || $any(a).antibiotic?.core?.indication">
                  • Indication: {{ ($any(a).indication) || ($any(a).antibiotic?.core?.indication) }}
                </ng-container>
              </span>

              <span *ngSwitchDefault>—</span>
            </ng-container>
          </td>
        </ng-container>

        <!-- Signed -->
        <ng-container matColumnDef="signed">
          <th mat-header-cell *matHeaderCellDef>Signed by</th>
          <td mat-cell *matCellDef="let a">
            {{ a.eSignature?.signerName || a.eSignature?.signerEmail || '—' }}
          </td>
        </ng-container>

        <!-- PDF -->
        <ng-container matColumnDef="pdf">
          <th mat-header-cell *matHeaderCellDef>PDF</th>
          <td mat-cell *matCellDef="let a">
            <a *ngIf="a.pdfUrl" [href]="a.pdfUrl" target="_blank">open</a>
            <span *ngIf="!a.pdfUrl">—</span>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let a">
            <button *ngIf="a.type === 'vitalSigns'"
                    mat-icon-button
                    aria-label="Open vitals trend"
                    (click)="openVitalsTrend(); $event.stopPropagation()">
              <mat-icon>show_chart</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['createdAt','summary','signed','pdf','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['createdAt','summary','signed','pdf','actions']"></tr>
      </table>
    </mat-tab>
  </mat-tab-group>
</mat-card>
