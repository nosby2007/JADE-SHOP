<mat-card class="kpi-grid">
    <div class="kpi">
      <div class="kpi-title">Utilisateurs</div>
      <div class="kpi-value">{{ totals.users }}</div>
      <div class="kpi-sub">Total comptes</div>
    </div>
  
    <div class="kpi">
      <div class="kpi-title">Admins</div>
      <div class="kpi-value">{{ totals.admins }}</div>
      <div class="kpi-sub">Accès complets</div>
    </div>
  
    <div class="kpi">
      <div class="kpi-title">Désactivés</div>
      <div class="kpi-value warn">{{ totals.disabled }}</div>
      <div class="kpi-sub">Comptes bloqués</div>
    </div>
  
    <div class="kpi">
      <div class="kpi-title">Connexions (7j)</div>
      <div class="kpi-value">{{ totals.logins7d }}</div>
      <div class="kpi-sub">Activité récente</div>
    </div>
  </mat-card>
  
  <div class="grid-2">
    <mat-card class="chart">
      <mat-card-title>Répartition des rôles</mat-card-title>
      <div echarts [options]="rolePieOptions" class="echart"></div>
    </mat-card>
  
    <mat-card class="chart">
      <mat-card-title>Providers d’auth</mat-card-title>
      <div echarts [options]="providerBarOptions" class="echart"></div>
    </mat-card>
  
    <mat-card class="chart full">
      <mat-card-title>Connexions / jour (14j)</mat-card-title>
      <div echarts [options]="loginsLineOptions" class="echart tall"></div>
    </mat-card>
  </div>
  
  <div class="grid-2">
    <mat-card>
      <mat-card-title>Derniers utilisateurs</mat-card-title>
      <div class="table-wrap">
        <table mat-table [dataSource]="usersDS" class="mat-elevation-z2 full-table">
          <ng-container matColumnDef="displayName">
            <th mat-header-cell *matHeaderCellDef>Nom</th>
            <td mat-cell *matCellDef="let u">{{ u.displayName || '—' }}</td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let u">{{ u.email || '—' }}</td>
          </ng-container>
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Rôle</th>
            <td mat-cell *matCellDef="let u">{{ (u.roles?.[0] || u.role || 'user') }}</td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Statut</th>
            <td mat-cell *matCellDef="let u">
              <span [class.warn]="u.disabled">{{ u.disabled ? 'disabled' : (u.status || 'active') }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="lastLogin">
            <th mat-header-cell *matHeaderCellDef>Dernière connexion</th>
            <td mat-cell *matCellDef="let u">
              {{ toDate(u.lastLogin) || toDate(u.updatedAt) | date:'short' }}
            </td>
          </ng-container>
  
          <tr mat-header-row *matHeaderRowDef="userCols"></tr>
          <tr mat-row *matRowDef="let row; columns: userCols"></tr>
        </table>
        <mat-paginator #usersPaginator [pageSize]="5"></mat-paginator>
      </div>
    </mat-card>
  
    <mat-card>
      <mat-card-title>Erreurs récentes</mat-card-title>
      <div class="table-wrap">
        <table mat-table [dataSource]="errorsDS" class="mat-elevation-z2 full-table">
          <ng-container matColumnDef="ts">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let e">{{ e.ts | date:'short' }}</td>
          </ng-container>
          <ng-container matColumnDef="level">
            <th mat-header-cell *matHeaderCellDef>Niveau</th>
            <td mat-cell *matCellDef="let e">{{ e.level }}</td>
          </ng-container>
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef>Message</th>
            <td mat-cell *matCellDef="let e">{{ e.message }}</td>
          </ng-container>
  
          <tr mat-header-row *matHeaderRowDef="errCols"></tr>
          <tr mat-row *matRowDef="let row; columns: errCols"></tr>
        </table>
        <mat-paginator #errorsPaginator [pageSize]="5"></mat-paginator>
        <div class="muted" *ngIf="errorsDS.data.length === 0">Aucune erreur récente.</div>
      </div>
    </mat-card>
  </div>
  
  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>
  